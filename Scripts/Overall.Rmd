---
title: "Overall Results"
author: "Hamza"
date: "30 September 2019"
output:
  pdf_document: default
  html_document: default
  word_document: default
---

```{r load packages, include=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(openxlsx)  
library(knitr)
library(metafor)
library(ggplot2)
library(readxl)

#Install miktex and then run this to knit a pdf file
#install.packages('tinytex')
#tinytex::install_tinytex()
```

## Meta-analysis

### Calculating effect sizes

Here, we calculated our effect sizes (log response ratio lnRR) for our complete data set (all traits).

```{r, include = FALSE}


#Import data
ALL_TRAITS <- read_excel("../data/ALL_TRAITS.xlsx")
```

## Meta-analysis overall results (lnRR)

### 1. Calculating effect sizes (Done)

We calculated our effect sizes (log response ratio lnRR) for our complete data set (all traits).
```{r, include = FALSE}

Effect_Size_All_Traits <- escalc(measure="ROM", m1i=Mean_Treatment, sd1i=SD_Treatment, n1i=Sample_Size_n_Treatment, m2i=Mean_Control, sd2i=SD_Control, n2i=Sample_Size_n_Control, data=ALL_TRAITS)

hist(Effect_Size_All_Traits$yi)
hist(log(Effect_Size_All_Traits$vi))

#Adding Effect Size ID's
ES_ID <- factor(1:dim(Effect_Size_All_Traits)[1])
Effect_Size_All_Traits$ES_ID <-ES_ID

#Converting into factors

Effect_Size_All_Traits$Trait <- factor(Effect_Size_All_Traits$Trait)
Effect_Size_All_Traits$Exposure_Type <- factor(Effect_Size_All_Traits$Exposure_Type)
Effect_Size_All_Traits$Sex <- factor(Effect_Size_All_Traits$Sex)
Effect_Size_All_Traits$Generation <- factor(Effect_Size_All_Traits$Generation)
Effect_Size_All_Traits$Cohort_ID <- factor(Effect_Size_All_Traits$Cohort_ID)
Effect_Size_All_Traits$Paper_ID <- factor(Effect_Size_All_Traits$Paper_ID)
Effect_Size_All_Traits$Rodent_type <- factor(Effect_Size_All_Traits$Rodent_type)
Effect_Size_All_Traits$F2_Diet_at_measurement <- factor(Effect_Size_All_Traits$F2_Diet_at_measurement)
Effect_Size_All_Traits$Strain <- factor(Effect_Size_All_Traits$Strain)
Effect_Size_All_Traits$F0_Parent_Exposed <- factor(Effect_Size_All_Traits$F0_Parent_Exposed)

Effect_Size_All_Traits$Sex <- gsub("Both ", "Both", Effect_Size_All_Traits$Sex)

#Subsetting by One off and Multigenerational

MG_ALL <- subset(Effect_Size_All_Traits, Effect_Size_All_Traits$Exposure_Type == "Multigenerational")

OF_ALL <- subset(Effect_Size_All_Traits, Effect_Size_All_Traits$Exposure_Type == "One off")

write.csv(Effect_Size_All_Traits, file ="Effect_Size_All_Traits.csv")

save(Effect_Size_All_Traits, file = "Effect_Size_All_Traits.RData") #DOUBLE CHECK THIS IS CORRECT FOR ALL TRAITS!!!
```

### 2. Deciding random effects (Done)
We used AIC values to decide which random effects to use. Combining "Trait", "ES_ID",Paper_ID" and "Cohort_ID" yielded the lowest AIC values. 
```{r, include= FALSE}
meta1null <- rma.mv(yi, vi, data=Effect_Size_All_Traits, method = 'ML') 

metastudy <- rma.mv(yi, vi,random = ~1|Cohort_ID, data=Effect_Size_All_Traits, method = 'ML') 
anova(meta1null, metastudy)
meta0study <- rma.mv(yi, vi,random = list(~1|Paper_ID, ~1|Cohort_ID), data=Effect_Size_All_Traits, method = 'ML') 
anova(meta1null, meta0study)
meta1study <- rma.mv(yi, vi,random = ~1|Trait, data=Effect_Size_All_Traits, method = 'ML') 
anova(meta1null, meta1study)
metastudy_best <- rma.mv(yi, vi,random = list(~1|Paper_ID,~1|Cohort_ID,~1|Trait), data=Effect_Size_All_Traits, method = 'ML') 
anova(meta0study, metastudy_best)

```

#### 3. Running meta-analysis (overall, with and without moderators)
I conducted meta-analysis, first on the complete dataset, with and without moderators.

```{r}
#ALL DATA

All_Traits_Analysis_0mods <- rma.mv(yi, vi, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Effect_Size_All_Traits, method = 'REML')

summary(All_Traits_Analysis_0mods)
funnel(All_Traits_Analysis_0mods,yaxis="seinv")


W <- diag(1/Effect_Size_All_Traits$vi)
X <- model.matrix(All_Traits_Analysis_0mods)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_overall <- 100 * sum(All_Traits_Analysis_0mods$sigma2) / (sum(All_Traits_Analysis_0mods$sigma2) + (All_Traits_Analysis_0mods$k-All_Traits_Analysis_0mods$p)/sum(diag(P)))
I2_overall

Overall_effect_size <- tibble(
  ID = "Overall", 
  lnRR = c(All_Traits_Analysis_0mods$b[1]),
  ci.lb = c(All_Traits_Analysis_0mods$ci.lb),
  ci.ub = c(All_Traits_Analysis_0mods$ci.ub),
  k = 241
)

plot_lnRR_overall <- ggplot(Overall_effect_size, aes(x=ID, y=lnRR)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0.05, position = position_dodge(0.3)) +
  geom_point(aes(x = ID, y = lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "ID", y = "lnRR", subtitle = "k=341") +
  coord_flip()
plot_lnRR_overall
```
### Meta Regression for Traits and Exposure Type
```{r}

### Meta Regression

#Traits meta-regression
All_Traits_Analysis_traits <- rma.mv(yi, vi, mods= ~Trait-1, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Effect_Size_All_Traits, method = 'REML')

summary(All_Traits_Analysis_traits)
funnel(All_Traits_Analysis_traits,yaxis="seinv")

W <- diag(1/Effect_Size_All_Traits$vi)
X <- model.matrix(All_Traits_Analysis_traits)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_Overall_Traits <- 100 * sum(All_Traits_Analysis_traits$sigma2) / (sum(All_Traits_Analysis_traits$sigma2) + (All_Traits_Analysis_traits$k-All_Traits_Analysis_traits$p)/sum(diag(P)))
I2_Overall_Traits

#Will not go into figure as of yet, just as a reference for how many effect sizes we see
k_traits <- Effect_Size_All_Traits %>% group_by(Trait) %>% count()
k_traits

Traits_overall_lnRR <- tibble(
  Trait = c("Adiposity", "Body Weight","Glucose FBG", "Glucose TT", "Insulin FI","Insulin TT", "Leptin", "Triglycerides"), 
  lnRR = c(All_Traits_Analysis_traits$b[1],All_Traits_Analysis_traits$b[2],All_Traits_Analysis_traits$b[3],All_Traits_Analysis_traits$b[4],All_Traits_Analysis_traits$b[5],All_Traits_Analysis_traits$b[6],All_Traits_Analysis_traits$b[7],All_Traits_Analysis_traits$b[8]),
  ci.lb = c(All_Traits_Analysis_traits$ci.lb[1],All_Traits_Analysis_traits$ci.lb[2],All_Traits_Analysis_traits$ci.lb[3],All_Traits_Analysis_traits$ci.lb[4],All_Traits_Analysis_traits$ci.lb[5],All_Traits_Analysis_traits$ci.lb[6],All_Traits_Analysis_traits$ci.lb[7],All_Traits_Analysis_traits$ci.lb[8]),
  ci.ub = c(All_Traits_Analysis_traits$ci.ub[1],All_Traits_Analysis_traits$ci.ub[2],All_Traits_Analysis_traits$ci.ub[3],All_Traits_Analysis_traits$ci.ub[4],All_Traits_Analysis_traits$ci.ub[5],All_Traits_Analysis_traits$ci.ub[6],All_Traits_Analysis_traits$ci.ub[7],All_Traits_Analysis_traits$ci.ub[8]),
  k = c(k_traits$n[1],k_traits$n[2],k_traits$n[3],k_traits$n[4],k_traits$n[5],k_traits$n[6],k_traits$n[7],k_traits$n[8])
)
Traits_overall_lnRR

plot_lnRR_overall_traits <- ggplot(Traits_overall_lnRR, aes(x=Trait, y=lnRR)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = Trait, y = lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Trait", y = "lnRR") +
  coord_flip()
plot_lnRR_overall_traits
```

```{r}

#Exposure type meta-regression
All_Traits_Analysis_Exp <- rma.mv(yi, vi, mods= ~Exposure_Type-1, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Effect_Size_All_Traits, method = 'REML')

summary(All_Traits_Analysis_Exp)
funnel(All_Traits_Analysis_Exp,yaxis="seinv")

W <- diag(1/Effect_Size_All_Traits$vi)
X <- model.matrix(All_Traits_Analysis_Exp)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_Overall_Exposure <- 100 * sum(All_Traits_Analysis_Exp$sigma2) / (sum(All_Traits_Analysis_Exp$sigma2) + (All_Traits_Analysis_Exp$k-All_Traits_Analysis_Exp$p)/sum(diag(P)))
I2_Overall_Exposure

k_exp <- Effect_Size_All_Traits %>% group_by(Exposure_Type) %>% count()
k_exp

Overall_Exp_meta_lnRR <- tibble(
  Exposure_Type = c("Multigenerational", "One off"), 
  lnRR = c(All_Traits_Analysis_Exp$b[1],All_Traits_Analysis_Exp$b[2]),
  ci.lb = c(All_Traits_Analysis_Exp$ci.lb[1],All_Traits_Analysis_Exp$ci.lb[2]),
  ci.ub = c(All_Traits_Analysis_Exp$ci.ub[1],All_Traits_Analysis_Exp$ci.ub[2]),
  k = c(k_exp$n[1],k_exp$n[2])
)
Overall_Exp_meta_lnRR

plot_lnRR_overall_expmeta <- ggplot(Overall_Exp_meta_lnRR, aes(x=Exposure_Type, y=lnRR, colour=Exposure_Type)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = Exposure_Type, y = lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Exposure_Type", y = "lnRR") +
  coord_flip()
plot_lnRR_overall_expmeta
```

### Meta-regression of overall dataset for F0 parent and offspring sex
```{r}
All_Data_Analysis_f0 <- rma.mv(yi, vi, mods = ~F0_Parent_Exposed-1, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Effect_Size_All_Traits, method = 'REML')

summary(All_Data_Analysis_f0)
funnel(All_Data_Analysis_f0,yaxis="seinv")

W <- diag(1/Effect_Size_All_Traits$vi)
X <- model.matrix(All_Data_Analysis_f0)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_Overall_F0 <- 100 * sum(All_Data_Analysis_f0$sigma2) / (sum(All_Data_Analysis_f0$sigma2) + (All_Data_Analysis_f0$k-All_Data_Analysis_f0$p)/sum(diag(P)))
I2_Overall_F0

k_All_Data_Analysis_f0 <- Effect_Size_All_Traits %>% group_by(F0_Parent_Exposed) %>% count()
k_All_Data_Analysis_f0

All_Data_Analysis_sex <- rma.mv(yi, vi, mods = ~Sex-1, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Effect_Size_All_Traits, method = 'REML')

summary(All_Data_Analysis_sex)
funnel(All_Data_Analysis_sex,yaxis="seinv")

W <- diag(1/Effect_Size_All_Traits$vi)
X <- model.matrix(All_Data_Analysis_sex)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_Overall_sex <- 100 * sum(All_Data_Analysis_sex$sigma2) / (sum(All_Data_Analysis_sex$sigma2) + (All_Data_Analysis_sex$k-All_Data_Analysis_sex$p)/sum(diag(P)))
I2_Overall_sex

Overall_effects_not_split_f0_sex <- tibble(
  Sex = c("Both", "Female", "Male", "Both", "Female", "Male"),
  Mod = c("Exposed F0", "Exposed F0", "Exposed F0","Grand-offspring Sex", "Grand-offspring Sex","Grand-offspring Sex"),
  lnRR = c(All_Data_Analysis_f0$b[1],All_Data_Analysis_f0$b[2],All_Data_Analysis_f0$b[3],All_Data_Analysis_sex$b[1],All_Data_Analysis_sex$b[2],All_Data_Analysis_sex$b[3]),
  ci.lb = c(All_Data_Analysis_f0$ci.lb[1],All_Data_Analysis_f0$ci.lb[2],All_Data_Analysis_f0$ci.lb[3],All_Data_Analysis_sex$ci.lb[1],All_Data_Analysis_sex$ci.lb[2],All_Data_Analysis_sex$ci.lb[3]),
  ci.ub = c(All_Data_Analysis_f0$ci.ub[1],All_Data_Analysis_f0$ci.ub[2],All_Data_Analysis_f0$ci.ub[3],All_Data_Analysis_sex$ci.ub[1],All_Data_Analysis_sex$ci.ub[2],All_Data_Analysis_sex$ci.ub[3])
)


plot_lnRR_overall_mods_f0_sex <- ggplot(Overall_effects_not_split_f0_sex, aes(x=Sex, y=lnRR, colour = Mod))+ 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0.05, position = position_dodge(0.3)) +
  geom_point(aes(x = Sex, y = lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Sex", y = "lnRR") +
  coord_flip()+
  facet_grid(~Mod)
 
plot_lnRR_overall_mods_f0_sex
```
### Meta-analysis with subsetted dataset (MG and OF exposure type)
```{r}

#Overall analysis split by exposure type
All_Data_Analysis_MG <- rma.mv(yi, vi, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=MG_ALL, method = 'REML')

summary(All_Data_Analysis_MG)
funnel(All_Data_Analysis_MG,yaxis="seinv")

W <- diag(1/MG_ALL$vi)
X <- model.matrix(All_Data_Analysis_MG)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_Overall_MG <- 100 * sum(All_Data_Analysis_MG$sigma2) / (sum(All_Data_Analysis_MG$sigma2) + (All_Data_Analysis_MG$k-All_Data_Analysis_MG$p)/sum(diag(P)))
I2_Overall_MG

All_Data_Analysis_OF <- rma.mv(yi, vi, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=OF_ALL, method = 'REML')

summary(All_Data_Analysis_OF)
funnel(All_Data_Analysis_OF,yaxis="seinv")

W <- diag(1/OF_ALL$vi)
X <- model.matrix(All_Data_Analysis_OF)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_Overall_OF <- 100 * sum(All_Data_Analysis_OF$sigma2) / (sum(All_Data_Analysis_OF$sigma2) + (All_Data_Analysis_OF$k-All_Data_Analysis_OF$p)/sum(diag(P)))
I2_Overall_OF

Overall_Exp_lnRR <- tibble(
  Exposure_Type = c("Multigenerational", "One off"), 
  lnRR = c(All_Data_Analysis_MG$b[1],All_Data_Analysis_OF$b[1]),
  ci.lb = c(All_Data_Analysis_MG$ci.lb[1],All_Data_Analysis_OF$ci.lb[1]),
  ci.ub = c(All_Data_Analysis_MG$ci.ub[1],All_Data_Analysis_OF$ci.ub[1]),
  k = c(118,223)
)
Overall_Exp_lnRR

plot_lnRR_overall_exp <- ggplot(Overall_Exp_lnRR, aes(x=Exposure_Type, y=lnRR, colour=Exposure_Type)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0.05, position = position_dodge(0.3)) +
  geom_point(aes(x = Exposure_Type, y = lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Exposure_Type", y = "lnRR") +
  coord_flip()
plot_lnRR_overall_exp
```

```{r}

#Overall analysis with moderators (by exposure type)
Traits_Analysis_MG <- rma.mv(yi, vi, mods = ~Trait-1, random = list( ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=MG_ALL, method = 'REML')

summary(Traits_Analysis_MG)
funnel(Traits_Analysis_MG,yaxis="seinv")

W <- diag(1/MG_ALL$vi)
X <- model.matrix(Traits_Analysis_MG)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_Trait_MG <- 100 * sum(Traits_Analysis_MG$sigma2) / (sum(Traits_Analysis_MG$sigma2) + (Traits_Analysis_MG$k-Traits_Analysis_MG$p)/sum(diag(P)))
I2_Trait_MG

k_traits_MG <- MG_ALL %>% group_by(Trait) %>% count()
k_traits_MG

Traits_Analysis_OF <- rma.mv(yi, vi, mods = ~Trait-1, random = list( ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=OF_ALL, method = 'REML')

summary(Traits_Analysis_OF)
funnel(Traits_Analysis_OF,yaxis="seinv")

W <- diag(1/OF_ALL$vi)
X <- model.matrix(Traits_Analysis_OF)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_Trait_OF <- 100 * sum(Traits_Analysis_OF$sigma2) / (sum(Traits_Analysis_OF$sigma2) + (Traits_Analysis_OF$k-Traits_Analysis_OF$p)/sum(diag(P)))
I2_Trait_OF

k_traits_OF <- OF_ALL %>% group_by(Trait) %>% count()
k_traits_OF

Traits_analysis_Exp <- tibble(
  Exposure_Type = c("Multigenerational","Multigenerational","Multigenerational","Multigenerational","Multigenerational","Multigenerational","Multigenerational","Multigenerational","One off","One off","One off","One off","One off","One off","One off","One off" ),
  Trait = c("Adiposity", "Body Weight", "Glucose_FBG","Glucose_TT", "Insulin_FI", "Insulin_TT","Leptin", "Triglycerides","Adiposity", "Body Weight", "Glucose_FBG","Glucose_TT", "Insulin_FI", "Insulin_TT","Leptin", "Triglycerides"),
  lnRR = c(Traits_Analysis_MG$b[1],Traits_Analysis_MG$b[2],Traits_Analysis_MG$b[3],Traits_Analysis_MG$b[4],Traits_Analysis_MG$b[5],Traits_Analysis_MG$b[6],Traits_Analysis_MG$b[7],Traits_Analysis_MG$b[8],Traits_Analysis_OF$b[1],Traits_Analysis_OF$b[2],Traits_Analysis_OF$b[3],Traits_Analysis_OF$b[4],Traits_Analysis_OF$b[5],Traits_Analysis_OF$b[6],Traits_Analysis_OF$b[7],Traits_Analysis_OF$b[8]),
  ci.lb = c(Traits_Analysis_MG$ci.lb[1],Traits_Analysis_MG$ci.lb[2],Traits_Analysis_MG$ci.lb[3],Traits_Analysis_MG$ci.lb[4],Traits_Analysis_MG$ci.lb[5],Traits_Analysis_MG$ci.lb[6],Traits_Analysis_MG$ci.lb[7],Traits_Analysis_MG$ci.lb[8],Traits_Analysis_OF$ci.lb[1],Traits_Analysis_OF$ci.lb[2],Traits_Analysis_OF$ci.lb[3],Traits_Analysis_OF$ci.lb[4],Traits_Analysis_OF$ci.lb[5],Traits_Analysis_OF$ci.lb[6],Traits_Analysis_OF$ci.lb[7],Traits_Analysis_OF$ci.lb[8]),
  ci.ub = c(Traits_Analysis_MG$ci.ub[1],Traits_Analysis_MG$ci.ub[2],Traits_Analysis_MG$ci.ub[3],Traits_Analysis_MG$ci.ub[4],Traits_Analysis_MG$ci.ub[5],Traits_Analysis_MG$ci.ub[6],Traits_Analysis_MG$ci.ub[7],Traits_Analysis_MG$ci.ub[8],Traits_Analysis_OF$ci.ub[1],Traits_Analysis_OF$ci.ub[2],Traits_Analysis_OF$ci.ub[3],Traits_Analysis_OF$ci.ub[4],Traits_Analysis_OF$ci.ub[5],Traits_Analysis_OF$ci.ub[6],Traits_Analysis_OF$ci.ub[7],Traits_Analysis_OF$ci.ub[8]),
  k = c(k_traits_MG$n[1],k_traits_MG$n[2],k_traits_MG$n[3],k_traits_MG$n[4],k_traits_MG$n[5],k_traits_MG$n[6],k_traits_MG$n[7],k_traits_MG$n[8],k_traits_OF$n[1],k_traits_OF$n[2],k_traits_OF$n[3],k_traits_OF$n[4],k_traits_OF$n[5],k_traits_OF$n[6],k_traits_OF$n[7],k_traits_OF$n[8])
)

plot_lnRR_overall_trait_exp <- ggplot(Traits_analysis_Exp, aes(x=Trait, y=lnRR, colour=Exposure_Type)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0.05, position = position_dodge(0.3)) +
  geom_point(aes(x = Trait, y = lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Exposure_Type", y = "lnRR") +
  coord_flip()+
  facet_grid(~Exposure_Type)
plot_lnRR_overall_trait_exp
```


```{r}

#F0 and offspring sex analysis
All_Traits_Analysis_0mods_MG_f0 <- rma.mv(yi, vi, mods = ~F0_Parent_Exposed-1, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=MG_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_MG_f0)
funnel(All_Traits_Analysis_0mods_MG_f0,yaxis="seinv")

All_Traits_Analysis_0mods_OF_f0 <- rma.mv(yi, vi, mods = ~F0_Parent_Exposed-1, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=OF_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_OF_f0)
funnel(All_Traits_Analysis_0mods_OF_f0,yaxis="seinv")

All_Traits_Analysis_0mods_MG_sex <- rma.mv(yi, vi, mods = ~Sex-1, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=MG_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_MG_sex)
funnel(All_Traits_Analysis_0mods_MG_sex,yaxis="seinv")


All_Traits_Analysis_0mods_OF_sex <- rma.mv(yi, vi, mods = ~Sex-1, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=OF_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_OF_sex)
funnel(All_Traits_Analysis_0mods_OF_sex,yaxis="seinv")

Overall_Exp_mods_lnRR <- tibble(
  Exposure_Type = c("Multigenerational","Multigenerational", "One off", "One off", "One off", "Multigenerational", "Multigenerational","Multigenerational", "One off","One off","One off" ),
  Sex = c("Female","Male", "Both", "Female", "Male","Both","Female", "Male", "Both","Female", "Male"),
  Mod = c("F0 Exposed","F0 Exposed","F0 Exposed","F0 Exposed","F0 Exposed", "Grand-offspring Sex","Grand-offspring Sex","Grand-offspring Sex","Grand-offspring Sex","Grand-offspring Sex","Grand-offspring Sex"),
  lnRR = c(All_Traits_Analysis_0mods_MG_f0$b[1], All_Traits_Analysis_0mods_MG_f0$b[2],All_Traits_Analysis_0mods_OF_f0$b[1],All_Traits_Analysis_0mods_OF_f0$b[2],All_Traits_Analysis_0mods_OF_f0$b[3],All_Traits_Analysis_0mods_MG_sex$b[1],All_Traits_Analysis_0mods_MG_sex$b[2], All_Traits_Analysis_0mods_MG_sex$b[3],All_Traits_Analysis_0mods_OF_sex$b[1],All_Traits_Analysis_0mods_OF_sex$b[2],All_Traits_Analysis_0mods_OF_sex$b[3]),
  ci.lb = c(All_Traits_Analysis_0mods_MG_f0$ci.lb[1], All_Traits_Analysis_0mods_MG_f0$ci.lb[2],All_Traits_Analysis_0mods_OF_f0$ci.lb[1],All_Traits_Analysis_0mods_OF_f0$ci.lb[2],All_Traits_Analysis_0mods_OF_f0$ci.lb[3],All_Traits_Analysis_0mods_MG_sex$ci.lb[1],All_Traits_Analysis_0mods_MG_sex$ci.lb[2],All_Traits_Analysis_0mods_MG_sex$ci.lb[3],All_Traits_Analysis_0mods_OF_sex$ci.lb[1],All_Traits_Analysis_0mods_OF_sex$ci.lb[2],All_Traits_Analysis_0mods_OF_sex$ci.lb[3]),
  ci.ub = c(All_Traits_Analysis_0mods_MG_f0$ci.ub[1], All_Traits_Analysis_0mods_MG_f0$ci.ub[2],All_Traits_Analysis_0mods_OF_f0$ci.ub[1],All_Traits_Analysis_0mods_OF_f0$ci.ub[2],All_Traits_Analysis_0mods_OF_f0$ci.ub[3],All_Traits_Analysis_0mods_MG_sex$ci.ub[1],All_Traits_Analysis_0mods_MG_sex$ci.ub[2],All_Traits_Analysis_0mods_MG_sex$ci.ub[3],All_Traits_Analysis_0mods_OF_sex$ci.ub[1],All_Traits_Analysis_0mods_OF_sex$ci.ub[2],All_Traits_Analysis_0mods_OF_sex$ci.ub[3])
)

plot_lnRR_overall_mods_exp <- ggplot(Overall_Exp_mods_lnRR, aes(x=Sex, y=lnRR, colour=Exposure_Type))+ 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0.05, position = position_dodge(0.3)) +
  geom_point(aes(x = Sex, y = lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Sex", y = "lnRR") +
  coord_flip()+
  facet_grid(~Mod)
 
plot_lnRR_overall_mods_exp

```


## Meta-analysis overall results (lnCVR)

### 4. Calculating effect sizes (Done)

We calculated our effect sizes (lnCVR) for our complete data set (all traits).
```{r, include = FALSE}

Effect_Size_All_Traits_lnCVR <- escalc(measure="CVR", m1i=Mean_Treatment, sd1i=SD_Treatment, n1i=Sample_Size_n_Treatment, m2i=Mean_Control, sd2i=SD_Control, n2i=Sample_Size_n_Control, data=ALL_TRAITS)

#Adding Effect Size ID's
ES_ID <- factor(1:dim(Effect_Size_All_Traits_lnCVR)[1])
Effect_Size_All_Traits_lnCVR$ES_ID <-ES_ID

#Converting into factors

Effect_Size_All_Traits_lnCVR$Trait <- factor(Effect_Size_All_Traits_lnCVR$Trait)
Effect_Size_All_Traits_lnCVR$Exposure_Type <- factor(Effect_Size_All_Traits_lnCVR$Exposure_Type)
Effect_Size_All_Traits_lnCVR$Sex <- factor(Effect_Size_All_Traits_lnCVR$Sex)
Effect_Size_All_Traits_lnCVR$Generation <- factor(Effect_Size_All_Traits_lnCVR$Generation)
Effect_Size_All_Traits_lnCVR$Cohort_ID <- factor(Effect_Size_All_Traits_lnCVR$Cohort_ID)
Effect_Size_All_Traits_lnCVR$Paper_ID <- factor(Effect_Size_All_Traits_lnCVR$Paper_ID)
Effect_Size_All_Traits_lnCVR$Rodent_type <- factor(Effect_Size_All_Traits_lnCVR$Rodent_type)
Effect_Size_All_Traits_lnCVR$F2_Diet_at_measurement <- factor(Effect_Size_All_Traits_lnCVR$F2_Diet_at_measurement)
Effect_Size_All_Traits_lnCVR$Strain <- factor(Effect_Size_All_Traits_lnCVR$Strain)
Effect_Size_All_Traits_lnCVR$F0_Parent_Exposed <- factor(Effect_Size_All_Traits_lnCVR$F0_Parent_Exposed)

Effect_Size_All_Traits_lnCVR$Sex <- gsub("Both ", "Both", Effect_Size_All_Traits_lnCVR$Sex)

#Subsetting into MG and OF
MG_ALL_lnCVR <- subset(Effect_Size_All_Traits_lnCVR, Effect_Size_All_Traits_lnCVR$Exposure_Type == "Multigenerational")

OF_ALL_lnCVR <- subset(Effect_Size_All_Traits_lnCVR, Effect_Size_All_Traits_lnCVR$Exposure_Type == "One off")

```



#### 5. Running meta-analysis for lnCVR
```{r}
#ALL DATA

All_Traits_Analysis_0mods_lnCVR <- rma.mv(yi, vi, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Effect_Size_All_Traits_lnCVR, method = 'REML')

summary(All_Traits_Analysis_0mods_lnCVR)
funnel(All_Traits_Analysis_0mods_lnCVR,yaxis="seinv")


W <- diag(1/Effect_Size_All_Traits_lnCVR$vi)
X <- model.matrix(All_Traits_Analysis_0mods_lnCVR)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_overall_lnCVR <- 100 * sum(All_Traits_Analysis_0mods_lnCVR$sigma2) / (sum(All_Traits_Analysis_0mods_lnCVR$sigma2) + (All_Traits_Analysis_0mods_lnCVR$k-All_Traits_Analysis_0mods_lnCVR$p)/sum(diag(P)))
I2_overall_lnCVR

Overall_effect_size_lnCVR <- tibble(
  ID = "Overall", 
  lnCVR = c(All_Traits_Analysis_0mods_lnCVR$b[1]),
  ci.lb = c(All_Traits_Analysis_0mods_lnCVR$ci.lb),
  ci.ub = c(All_Traits_Analysis_0mods_lnCVR$ci.ub),
  k = 241
)

plot_lnRR_overall_lnCVR <- ggplot(Overall_effect_size_lnCVR, aes(x=ID, y=lnCVR)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0.05, position = position_dodge(0.3)) +
  geom_point(aes(x = ID, y = lnCVR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "ID", y = "lnCVR", subtitle = "k=341") +
  coord_flip()
plot_lnRR_overall_lnCVR




```

### Meta Regression for Traits and Exposure Type lnCVR
```{r}

### Meta Regression

#Traits meta-regression
All_Traits_Analysis_traits_lnCVR <- rma.mv(yi, vi, mods= ~Trait-1, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Effect_Size_All_Traits_lnCVR, method = 'REML')

summary(All_Traits_Analysis_traits_lnCVR)
funnel(All_Traits_Analysis_traits_lnCVR,yaxis="seinv")

W <- diag(1/Effect_Size_All_Traits_lnCVR$vi)
X <- model.matrix(All_Traits_Analysis_traits_lnCVR)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_Overall_Traits_lnCVR <- 100 * sum(All_Traits_Analysis_traits_lnCVR$sigma2) / (sum(All_Traits_Analysis_traits_lnCVR$sigma2) + (All_Traits_Analysis_traits_lnCVR$k-All_Traits_Analysis_traits_lnCVR$p)/sum(diag(P)))
I2_Overall_Traits_lnCVR

#Will not go into figure as of yet, just as a reference for how many effect sizes we see
k_traits_lnCVR <- Effect_Size_All_Traits_lnCVR %>% group_by(Trait) %>% count()
k_traits_lnCVR

Traits_overall_lnCVR <- tibble(
  Trait = c("Adiposity", "Body Weight","Glucose FBG", "Glucose TT", "Insulin FI","Insulin TT", "Leptin", "Triglycerides"), 
  lnCVR = c(All_Traits_Analysis_traits_lnCVR$b[1],All_Traits_Analysis_traits_lnCVR$b[2],All_Traits_Analysis_traits_lnCVR$b[3],All_Traits_Analysis_traits_lnCVR$b[4],All_Traits_Analysis_traits_lnCVR$b[5],All_Traits_Analysis_traits_lnCVR$b[6],All_Traits_Analysis_traits_lnCVR$b[7],All_Traits_Analysis_traits_lnCVR$b[8]),
  ci.lb = c(All_Traits_Analysis_traits_lnCVR$ci.lb[1],All_Traits_Analysis_traits_lnCVR$ci.lb[2],All_Traits_Analysis_traits_lnCVR$ci.lb[3],All_Traits_Analysis_traits_lnCVR$ci.lb[4],All_Traits_Analysis_traits_lnCVR$ci.lb[5],All_Traits_Analysis_traits_lnCVR$ci.lb[6],All_Traits_Analysis_traits_lnCVR$ci.lb[7],All_Traits_Analysis_traits_lnCVR$ci.lb[8]),
  ci.ub = c(All_Traits_Analysis_traits_lnCVR$ci.ub[1],All_Traits_Analysis_traits_lnCVR$ci.ub[2],All_Traits_Analysis_traits_lnCVR$ci.ub[3],All_Traits_Analysis_traits_lnCVR$ci.ub[4],All_Traits_Analysis_traits_lnCVR$ci.ub[5],All_Traits_Analysis_traits_lnCVR$ci.ub[6],All_Traits_Analysis_traits_lnCVR$ci.ub[7],All_Traits_Analysis_traits_lnCVR$ci.ub[8]),
  k = c(k_traits_lnCVR$n[1],k_traits_lnCVR$n[2],k_traits_lnCVR$n[3],k_traits_lnCVR$n[4],k_traits_lnCVR$n[5],k_traits_lnCVR$n[6],k_traits_lnCVR$n[7],k_traits_lnCVR$n[8])
)
Traits_overall_lnCVR

plot_lnRR_overall_traits_lnCVR <- ggplot(Traits_overall_lnCVR, aes(x=Trait, y=lnCVR)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = Trait, y = lnCVR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Trait", y = "lnCVR") +
  coord_flip()
plot_lnRR_overall_traits_lnCVR
```


```{r}

#Exposure type meta-regression
All_Traits_Analysis_Exp_lnCVR <- rma.mv(yi, vi, mods= ~Exposure_Type-1, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Effect_Size_All_Traits_lnCVR, method = 'REML')

summary(All_Traits_Analysis_Exp_lnCVR)
funnel(All_Traits_Analysis_Exp_lnCVR,yaxis="seinv")

W <- diag(1/Effect_Size_All_Traits_lnCVR$vi)
X <- model.matrix(All_Traits_Analysis_Exp_lnCVR)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_Overall_Exposure_lnCVR <- 100 * sum(All_Traits_Analysis_Exp_lnCVR$sigma2) / (sum(All_Traits_Analysis_Exp_lnCVR$sigma2) + (All_Traits_Analysis_Exp_lnCVR$k-All_Traits_Analysis_Exp_lnCVR$p)/sum(diag(P)))
I2_Overall_Exposure_lnCVR

k_exp_lnCVR <- Effect_Size_All_Traits_lnCVR %>% group_by(Exposure_Type) %>% count()
k_exp_lnCVR

Overall_Exp_meta_lnCVR <- tibble(
  Exposure_Type = c("Multigenerational", "One off"), 
  lnCVR = c(All_Traits_Analysis_Exp_lnCVR$b[1],All_Traits_Analysis_Exp_lnCVR$b[2]),
  ci.lb = c(All_Traits_Analysis_Exp_lnCVR$ci.lb[1],All_Traits_Analysis_Exp_lnCVR$ci.lb[2]),
  ci.ub = c(All_Traits_Analysis_Exp_lnCVR$ci.ub[1],All_Traits_Analysis_Exp_lnCVR$ci.ub[2]),
  k = c(k_exp_lnCVR$n[1],k_exp_lnCVR$n[2])
)
Overall_Exp_meta_lnCVR

plot_lnRR_overall_expmeta_lnCVR <- ggplot(Overall_Exp_meta_lnCVR, aes(x=Exposure_Type, y=lnCVR, colour=Exposure_Type)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = Exposure_Type, y = lnCVR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Exposure_Type", y = "lnCVR") +
  coord_flip()
plot_lnRR_overall_expmeta_lnCVR
```

### Meta-regression of overall dataset for F0 parent and offspring sex lnCVR
```{r}
All_Data_Analysis_f0_lnCVR <- rma.mv(yi, vi, mods = ~F0_Parent_Exposed-1, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Effect_Size_All_Traits_lnCVR, method = 'REML')

summary(All_Data_Analysis_f0_lnCVR)
funnel(All_Data_Analysis_f0_lnCVR,yaxis="seinv")

W <- diag(1/Effect_Size_All_Traits_lnCVR$vi)
X <- model.matrix(All_Data_Analysis_f0_lnCVR)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_Overall_F0_lnCVR <- 100 * sum(All_Data_Analysis_f0_lnCVR$sigma2) / (sum(All_Data_Analysis_f0_lnCVR$sigma2) + (All_Data_Analysis_f0_lnCVR$k-All_Data_Analysis_f0_lnCVR$p)/sum(diag(P)))
I2_Overall_F0_lnCVR

k_All_Data_Analysis_f0_lnCVR <- Effect_Size_All_Traits_lnCVR %>% group_by(F0_Parent_Exposed) %>% count()
k_All_Data_Analysis_f0_lnCVR

All_Data_Analysis_sex_lnCVR <- rma.mv(yi, vi, mods = ~Sex-1, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Effect_Size_All_Traits_lnCVR, method = 'REML')

summary(All_Data_Analysis_sex_lnCVR)
funnel(All_Data_Analysis_sex_lnCVR,yaxis="seinv")

W <- diag(1/Effect_Size_All_Traits_lnCVR$vi)
X <- model.matrix(All_Data_Analysis_sex_lnCVR)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_Overall_sex_lnCVR <- 100 * sum(All_Data_Analysis_sex_lnCVR$sigma2) / (sum(All_Data_Analysis_sex_lnCVR$sigma2) + (All_Data_Analysis_sex_lnCVR$k-All_Data_Analysis_sex_lnCVR$p)/sum(diag(P)))
I2_Overall_sex_lnCVR

Overall_effects_not_split_f0_sex_lnCVR <- tibble(
  Sex = c("Both", "Female", "Male", "Both", "Female", "Male"),
  Mod = c("Exposed F0", "Exposed F0", "Exposed F0","Grand-offspring Sex", "Grand-offspring Sex","Grand-offspring Sex"),
  lnCVR = c(All_Data_Analysis_f0_lnCVR$b[1],All_Data_Analysis_f0_lnCVR$b[2],All_Data_Analysis_f0_lnCVR$b[3],All_Data_Analysis_sex_lnCVR$b[1],All_Data_Analysis_sex_lnCVR$b[2],All_Data_Analysis_sex_lnCVR$b[3]),
  ci.lb = c(All_Data_Analysis_f0_lnCVR$ci.lb[1],All_Data_Analysis_f0_lnCVR$ci.lb[2],All_Data_Analysis_f0_lnCVR$ci.lb[3],All_Data_Analysis_sex_lnCVR$ci.lb[1],All_Data_Analysis_sex_lnCVR$ci.lb[2],All_Data_Analysis_sex_lnCVR$ci.lb[3]),
  ci.ub = c(All_Data_Analysis_f0_lnCVR$ci.ub[1],All_Data_Analysis_f0_lnCVR$ci.ub[2],All_Data_Analysis_f0_lnCVR$ci.ub[3],All_Data_Analysis_sex_lnCVR$ci.ub[1],All_Data_Analysis_sex_lnCVR$ci.ub[2],All_Data_Analysis_sex_lnCVR$ci.ub[3])
)


plot_lnCVR_overall_mods_f0_sex <- ggplot(Overall_effects_not_split_f0_sex_lnCVR, aes(x=Sex, y=lnCVR, colour = Mod))+ 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0.05, position = position_dodge(0.3)) +
  geom_point(aes(x = Sex, y = lnCVR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Sex", y = "lnCVR") +
  coord_flip()+
  facet_grid(~Mod)
 
plot_lnCVR_overall_mods_f0_sex
```
### Meta-analysis with subsetted dataset (MG and OF exposure type)
```{r}

#Overall analysis split by exposure type
All_Data_Analysis_MG_lnCVR <- rma.mv(yi, vi, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=MG_ALL_lnCVR, method = 'REML')

summary(All_Data_Analysis_MG_lnCVR)
funnel(All_Data_Analysis_MG_lnCVR,yaxis="seinv")

W <- diag(1/MG_ALL_lnCVR$vi)
X <- model.matrix(All_Data_Analysis_MG_lnCVR)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_Overall_MG_lnCVR <- 100 * sum(All_Data_Analysis_MG_lnCVR$sigma2) / (sum(All_Data_Analysis_MG_lnCVR$sigma2) + (All_Data_Analysis_MG_lnCVR$k-All_Data_Analysis_MG_lnCVR$p)/sum(diag(P)))
I2_Overall_MG_lnCVR

All_Data_Analysis_OF_lnCVR <- rma.mv(yi, vi, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=OF_ALL_lnCVR, method = 'REML')

summary(All_Data_Analysis_OF_lnCVR)
funnel(All_Data_Analysis_OF_lnCVR,yaxis="seinv")

W <- diag(1/OF_ALL_lnCVR$vi)
X <- model.matrix(All_Data_Analysis_OF_lnCVR)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_Overall_OF_lnCVR <- 100 * sum(All_Data_Analysis_OF_lnCVR$sigma2) / (sum(All_Data_Analysis_OF_lnCVR$sigma2) + (All_Data_Analysis_OF_lnCVR$k-All_Data_Analysis_OF_lnCVR$p)/sum(diag(P)))
I2_Overall_OF_lnCVR

Overall_Exp_lnCVR <- tibble(
  Exposure_Type = c("Multigenerational", "One off"), 
  lnCVR = c(All_Data_Analysis_MG_lnCVR$b[1],All_Data_Analysis_OF_lnCVR$b[1]),
  ci.lb = c(All_Data_Analysis_MG_lnCVR$ci.lb[1],All_Data_Analysis_OF_lnCVR$ci.lb[1]),
  ci.ub = c(All_Data_Analysis_MG_lnCVR$ci.ub[1],All_Data_Analysis_OF_lnCVR$ci.ub[1]),
  k = c(118,223)
)
Overall_Exp_lnCVR

plot_lnCVR_overall_exp <- ggplot(Overall_Exp_lnCVR, aes(x=Exposure_Type, y=lnCVR, colour=Exposure_Type)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0.05, position = position_dodge(0.3)) +
  geom_point(aes(x = Exposure_Type, y = lnCVR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Exposure_Type", y = "lnCVR") +
  coord_flip()
plot_lnCVR_overall_exp
```

```{r}

#Overall analysis with moderators (by exposure type)
Traits_Analysis_MG_lnCVR <- rma.mv(yi, vi, mods = ~Trait-1, random = list( ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=MG_ALL_lnCVR, method = 'REML')

summary(Traits_Analysis_MG_lnCVR)
funnel(Traits_Analysis_MG_lnCVR,yaxis="seinv")

W <- diag(1/MG_ALL$vi)
X <- model.matrix(Traits_Analysis_MG_lnCVR)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_Trait_MG_lnCVR <- 100 * sum(Traits_Analysis_MG_lnCVR$sigma2) / (sum(Traits_Analysis_MG_lnCVR$sigma2) + (Traits_Analysis_MG_lnCVR$k-Traits_Analysis_MG_lnCVR$p)/sum(diag(P)))
I2_Trait_MG_lnCVR

k_traits_MG_lnCVR <- MG_ALL_lnCVR %>% group_by(Trait) %>% count()
k_traits_MG_lnCVR

Traits_Analysis_OF_lnCVR <- rma.mv(yi, vi, mods = ~Trait-1, random = list( ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=OF_ALL_lnCVR, method = 'REML')

summary(Traits_Analysis_OF_lnCVR)
funnel(Traits_Analysis_OF_lnCVR,yaxis="seinv")

W <- diag(1/OF_ALL_lnCVR$vi)
X <- model.matrix(Traits_Analysis_OF_lnCVR)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_Trait_OF_lnCVR <- 100 * sum(Traits_Analysis_OF_lnCVR$sigma2) / (sum(Traits_Analysis_OF_lnCVR$sigma2) + (Traits_Analysis_OF_lnCVR$k-Traits_Analysis_OF_lnCVR$p)/sum(diag(P)))
I2_Trait_OF_lnCVR

k_traits_OF_lnCVR <- OF_ALL_lnCVR %>% group_by(Trait) %>% count()
k_traits_OF_lnCVR

Traits_analysis_Exp_lnCVR <- tibble(
  Exposure_Type = c("Multigenerational","Multigenerational","Multigenerational","Multigenerational","Multigenerational","Multigenerational","Multigenerational","Multigenerational","One off","One off","One off","One off","One off","One off","One off","One off" ),
  Trait = c("Adiposity", "Body Weight", "Glucose_FBG","Glucose_TT", "Insulin_FI", "Insulin_TT","Leptin", "Triglycerides","Adiposity", "Body Weight", "Glucose_FBG","Glucose_TT", "Insulin_FI", "Insulin_TT","Leptin", "Triglycerides"),
  lnCVR = c(Traits_Analysis_MG_lnCVR$b[1],Traits_Analysis_MG_lnCVR$b[2],Traits_Analysis_MG_lnCVR$b[3],Traits_Analysis_MG_lnCVR$b[4],Traits_Analysis_MG_lnCVR$b[5],Traits_Analysis_MG_lnCVR$b[6],Traits_Analysis_MG_lnCVR$b[7],Traits_Analysis_MG_lnCVR$b[8],Traits_Analysis_OF_lnCVR$b[1],Traits_Analysis_OF_lnCVR$b[2],Traits_Analysis_OF_lnCVR$b[3],Traits_Analysis_OF_lnCVR$b[4],Traits_Analysis_OF_lnCVR$b[5],Traits_Analysis_OF_lnCVR$b[6],Traits_Analysis_OF_lnCVR$b[7],Traits_Analysis_OF_lnCVR$b[8]),
  ci.lb = c(Traits_Analysis_MG_lnCVR$ci.lb[1],Traits_Analysis_MG_lnCVR$ci.lb[2],Traits_Analysis_MG_lnCVR$ci.lb[3],Traits_Analysis_MG_lnCVR$ci.lb[4],Traits_Analysis_MG_lnCVR$ci.lb[5],Traits_Analysis_MG_lnCVR$ci.lb[6],Traits_Analysis_MG_lnCVR$ci.lb[7],Traits_Analysis_MG_lnCVR$ci.lb[8],Traits_Analysis_OF_lnCVR$ci.lb[1],Traits_Analysis_OF_lnCVR$ci.lb[2],Traits_Analysis_OF_lnCVR$ci.lb[3],Traits_Analysis_OF_lnCVR$ci.lb[4],Traits_Analysis_OF_lnCVR$ci.lb[5],Traits_Analysis_OF_lnCVR$ci.lb[6],Traits_Analysis_OF_lnCVR$ci.lb[7],Traits_Analysis_OF_lnCVR$ci.lb[8]),
  ci.ub = c(Traits_Analysis_MG_lnCVR$ci.ub[1],Traits_Analysis_MG_lnCVR$ci.ub[2],Traits_Analysis_MG_lnCVR$ci.ub[3],Traits_Analysis_MG_lnCVR$ci.ub[4],Traits_Analysis_MG_lnCVR$ci.ub[5],Traits_Analysis_MG_lnCVR$ci.ub[6],Traits_Analysis_MG_lnCVR$ci.ub[7],Traits_Analysis_MG_lnCVR$ci.ub[8],Traits_Analysis_OF_lnCVR$ci.ub[1],Traits_Analysis_OF_lnCVR$ci.ub[2],Traits_Analysis_OF_lnCVR$ci.ub[3],Traits_Analysis_OF_lnCVR$ci.ub[4],Traits_Analysis_OF_lnCVR$ci.ub[5],Traits_Analysis_OF_lnCVR$ci.ub[6],Traits_Analysis_OF_lnCVR$ci.ub[7],Traits_Analysis_OF_lnCVR$ci.ub[8]),
  k = c(k_traits_MG_lnCVR$n[1],k_traits_MG_lnCVR$n[2],k_traits_MG_lnCVR$n[3],k_traits_MG_lnCVR$n[4],k_traits_MG_lnCVR$n[5],k_traits_MG_lnCVR$n[6],k_traits_MG_lnCVR$n[7],k_traits_MG_lnCVR$n[8],k_traits_OF_lnCVR$n[1],k_traits_OF_lnCVR$n[2],k_traits_OF_lnCVR$n[3],k_traits_OF_lnCVR$n[4],k_traits_OF_lnCVR$n[5],k_traits_OF_lnCVR$n[6],k_traits_OF_lnCVR$n[7],k_traits_OF_lnCVR$n[8])
)

plot_lnCVR_overall_trait_exp <- ggplot(Traits_analysis_Exp_lnCVR, aes(x=Trait, y=lnCVR, colour=Exposure_Type)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0.05, position = position_dodge(0.3)) +
  geom_point(aes(x = Trait, y = lnCVR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Exposure_Type", y = "lnCVR") +
  coord_flip()+
  facet_grid(~Exposure_Type)
plot_lnCVR_overall_trait_exp
```


```{r}

#F0 and offspring sex analysis
All_Traits_Analysis_0mods_MG_f0_lnCVR <- rma.mv(yi, vi, mods = ~F0_Parent_Exposed-1, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=MG_ALL_lnCVR, method = 'REML')

summary(All_Traits_Analysis_0mods_MG_f0_lnCVR)
funnel(All_Traits_Analysis_0mods_MG_f0_lnCVR,yaxis="seinv")

All_Traits_Analysis_0mods_OF_f0_lnCVR <- rma.mv(yi, vi, mods = ~F0_Parent_Exposed-1, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=OF_ALL_lnCVR, method = 'REML')

summary(All_Traits_Analysis_0mods_OF_f0_lnCVR)
funnel(All_Traits_Analysis_0mods_OF_f0_lnCVR,yaxis="seinv")

All_Traits_Analysis_0mods_MG_sex_lnCVR <- rma.mv(yi, vi, mods = ~Sex-1, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=MG_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_MG_sex_lnCVR)
funnel(All_Traits_Analysis_0mods_MG_sex,yaxis="seinv")


All_Traits_Analysis_0mods_OF_sex_lnCVR <- rma.mv(yi, vi, mods = ~Sex-1, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=OF_ALL_lnCVR, method = 'REML')

summary(All_Traits_Analysis_0mods_OF_sex_lnCVR)
funnel(All_Traits_Analysis_0mods_OF_sex_lnCVR,yaxis="seinv")

Overall_Exp_mods_lnCVR <- tibble(
  Exposure_Type = c("Multigenerational","Multigenerational", "One off", "One off", "One off", "Multigenerational", "Multigenerational","Multigenerational", "One off","One off","One off" ),
  Sex = c("Female","Male", "Both", "Female", "Male","Both","Female", "Male", "Both","Female", "Male"),
  Mod = c("F0 Exposed","F0 Exposed","F0 Exposed","F0 Exposed","F0 Exposed", "Grand-offspring Sex","Grand-offspring Sex","Grand-offspring Sex","Grand-offspring Sex","Grand-offspring Sex","Grand-offspring Sex"),
  lnCVR = c(All_Traits_Analysis_0mods_MG_f0_lnCVR$b[1], All_Traits_Analysis_0mods_MG_f0_lnCVR$b[2],All_Traits_Analysis_0mods_OF_f0_lnCVR$b[1],All_Traits_Analysis_0mods_OF_f0_lnCVR$b[2],All_Traits_Analysis_0mods_OF_f0_lnCVR$b[3],All_Traits_Analysis_0mods_MG_sex_lnCVR$b[1],All_Traits_Analysis_0mods_MG_sex_lnCVR$b[2], All_Traits_Analysis_0mods_MG_sex_lnCVR$b[3],All_Traits_Analysis_0mods_OF_sex_lnCVR$b[1],All_Traits_Analysis_0mods_OF_sex_lnCVR$b[2],All_Traits_Analysis_0mods_OF_sex_lnCVR$b[3]),
  ci.lb = c(All_Traits_Analysis_0mods_MG_f0_lnCVR$ci.lb[1], All_Traits_Analysis_0mods_MG_f0_lnCVR$ci.lb[2],All_Traits_Analysis_0mods_OF_f0_lnCVR$ci.lb[1],All_Traits_Analysis_0mods_OF_f0_lnCVR$ci.lb[2],All_Traits_Analysis_0mods_OF_f0_lnCVR$ci.lb[3],All_Traits_Analysis_0mods_MG_sex_lnCVR$ci.lb[1],All_Traits_Analysis_0mods_MG_sex_lnCVR$ci.lb[2],All_Traits_Analysis_0mods_MG_sex_lnCVR$ci.lb[3],All_Traits_Analysis_0mods_OF_sex_lnCVR$ci.lb[1],All_Traits_Analysis_0mods_OF_sex_lnCVR$ci.lb[2],All_Traits_Analysis_0mods_OF_sex_lnCVR$ci.lb[3]),
  ci.ub = c(All_Traits_Analysis_0mods_MG_f0_lnCVR$ci.ub[1], All_Traits_Analysis_0mods_MG_f0_lnCVR$ci.ub[2],All_Traits_Analysis_0mods_OF_f0_lnCVR$ci.ub[1],All_Traits_Analysis_0mods_OF_f0_lnCVR$ci.ub[2],All_Traits_Analysis_0mods_OF_f0_lnCVR$ci.ub[3],All_Traits_Analysis_0mods_MG_sex_lnCVR$ci.ub[1],All_Traits_Analysis_0mods_MG_sex_lnCVR$ci.ub[2],All_Traits_Analysis_0mods_MG_sex_lnCVR$ci.ub[3],All_Traits_Analysis_0mods_OF_sex_lnCVR$ci.ub[1],All_Traits_Analysis_0mods_OF_sex_lnCVR$ci.ub[2],All_Traits_Analysis_0mods_OF_sex_lnCVR$ci.ub[3])
)

Overall_Exp_mods_lnCVR

plot_lnCVR_overall_mods_exp <- ggplot(Overall_Exp_mods_lnCVR, aes(x=Sex, y=lnCVR, colour=Exposure_Type))+ 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0.05, position = position_dodge(0.3)) +
  geom_point(aes(x = Sex, y = lnCVR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Sex", y = "lnCVR") +
  coord_flip()+
  facet_grid(~Mod)
 
plot_lnCVR_overall_mods_exp

```













