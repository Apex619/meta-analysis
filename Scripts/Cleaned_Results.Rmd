---
title: "Cleaned Results"
author: "Hamza"
date: "30 September 2019"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r load packages, include=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(openxlsx)  
library(knitr)
library(metafor)
library(ggplot2)
library(readxl)
```

## Meta-analysis

### Calculating effect sizes

Here, we calculated our effect sizes (log response ratio lnRR) for our complete data set (all traits).

```{r, include = FALSE}


#Import data
ALL_TRAITS <- read_excel("C:\\Users\\hamanw\\Dropbox\\Meta Analysis Project\\Extraction\\Transgenerational Meta-Analysis\\R\\data\\ALL_TRAITS.xlsx")

MG_ALL <- read_excel("C:\\Users\\hamanw\\Dropbox\\Meta Analysis Project\\Extraction\\Transgenerational Meta-Analysis\\R\\data\\MG_ALL.xlsx")

OF_ALL <- read_excel("C:\\Users\\hamanw\\Dropbox\\Meta Analysis Project\\Extraction\\Transgenerational Meta-Analysis\\R\\data\\OF_ALL.xlsx")

Overall_effect_size <- read_excel("C:\\Users\\hamanw\\Dropbox\\Meta Analysis Project\\Extraction\\Transgenerational Meta-Analysis\\R\\data\\Overall effect size.xlsx")

Overall_MG_OF <- read_excel("C:\\Users\\hamanw\\Dropbox\\Meta Analysis Project\\Extraction\\Transgenerational Meta-Analysis\\R\\data\\Overall_MG_OF.xlsx")

Overall_effects_not_split <- read_excel("C:\\Users\\hamanw\\Dropbox\\Meta Analysis Project\\Extraction\\Transgenerational Meta-Analysis\\R\\data\\Overall_effects_not_split.xlsx")

Table_results_overall <- read_excel("C:\\Users\\hamanw\\Dropbox\\Meta Analysis Project\\Extraction\\Transgenerational Meta-Analysis\\R\\data\\Table results.xlsx")

```

## Meta-analysis

### Calculating effect sizes

Here, we calculated our effect sizes (log response ratio lnRR) for our complete data set (all traits).
```{r, include = FALSE}

Effect_Size_All_Traits <- escalc(measure="ROM", m1i=Mean_Treatment, sd1i=SD_Treatment, n1i=Sample_Size_n_Treatment, m2i=Mean_Control, sd2i=SD_Control, n2i=Sample_Size_n_Control, data=ALL_TRAITS)

hist(Effect_Size_All_Traits$yi)
hist(log(Effect_Size_All_Traits$vi))
```

### Deciding random effects
We used AIC values to decide which random effects to use. Combining "Trait", "Paper_ID" and "Cohort_ID" yielded the lowest AIC values. 
```{r, include= FALSE}
meta1null <- rma.mv(yi, vi, data=Effect_Size_All_Traits, method = 'ML') 

metastudy <- rma.mv(yi, vi,random = ~1|Cohort_ID, data=Effect_Size_All_Traits, method = 'ML') 
anova(meta1null, metastudy)
meta0study <- rma.mv(yi, vi,random = list(~1|Paper_ID, ~1|Cohort_ID), data=Effect_Size_All_Traits, method = 'ML') 
anova(meta1null, meta0study)
meta1study <- rma.mv(yi, vi,random = ~1|Trait, data=Effect_Size_All_Traits, method = 'ML') 
anova(meta1null, meta1study)
```

```{r}
metastudy_best <- rma.mv(yi, vi,random = list(~1|Paper_ID,~1|Cohort_ID,~1|Trait), data=Effect_Size_All_Traits, method = 'ML') 
anova(meta0study, metastudy_best)

```

#### Running meta-analysis (overall, and then overall split by exposure type)

```{r, include = FALSE}
#ALL OF and MG

All_Traits_Analysis_0mods <- rma.mv(yi, vi, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=Effect_Size_All_Traits, method = 'REML')

summary(All_Traits_Analysis_0mods)

# Modelling all traits with no mods MG (lnRR)
All_Traits_Analysis_0mods_MG <- rma.mv(yi, vi, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=MG_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_MG)

#Heterogeneity I2 (adapt for all models)
W <- diag(1/MG_ALL$vi)
X <- model.matrix(All_Traits_Analysis_0mods_MG)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_MG <- 100 * sum(All_Traits_Analysis_0mods_MG$sigma2) / (sum(All_Traits_Analysis_0mods_MG$sigma2) + (All_Traits_Analysis_0mods_MG$k-All_Traits_Analysis_0mods_MG$p)/sum(diag(P)))
I2_MG

# Modelling all traits with no mods OF (lnRR)
All_Traits_Analysis_0mods_OF <- rma.mv(yi, vi, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=OF_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_OF)

W <- diag(1/OF_ALL$vi)
X <- model.matrix(All_Traits_Analysis_0mods_OF)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_OF <- 100 * sum(All_Traits_Analysis_0mods_OF$sigma2) / (sum(All_Traits_Analysis_0mods_OF$sigma2) + (All_Traits_Analysis_0mods_OF$k-All_Traits_Analysis_0mods_OF$p)/sum(diag(P)))
I2_OF


#Dataframe was created using results from above meta-analysis models
```


```{r}
#Plotting overall

plot_lnRR_overall <- ggplot(Overall_effect_size, aes(x=ID, y=Effect_Size_lnRR, colour=Experiment_Type)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = ID, y = Effect_Size_lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(title ="Difference between treatment and control in means, overall", x = "ID", y = "lnRR") +
  coord_flip()
 
plot_lnRR_overall

#Plotting overall when split by multigenerational and one off exposure

plot_lnRR_overall_exposure <- ggplot(Overall_MG_OF, aes(x=ID, y=Effect_Size_lnRR, colour=Experiment_Type)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = ID, y = Effect_Size_lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(title ="Difference between treatment and control in means, overall", x = "ID", y = "lnRR") +
  coord_flip()
 
plot_lnRR_overall_exposure

```

#### Running meta-analysis (Overall with moderators, and then overall split by exposure type with moderators)

```{r, include=FALSE}
#Adding moderators
All_Data_Analysis_f0 <- rma.mv(yi, vi, mods = ~F0_Parent_Exposed, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=Effect_Size_All_Traits, method = 'REML')

summary(All_Data_Analysis_f0)

All_Data_Analysis_rodents <- rma.mv(yi, vi, mods = ~Rodent_type, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=Effect_Size_All_Traits, method = 'REML')

summary(All_Data_Analysis_rodents)


All_Data_Analysis_sex <- rma.mv(yi, vi, mods = ~Sex, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=Effect_Size_All_Traits, method = 'REML')

summary(All_Data_Analysis_sex)
```
```{r}

#Plotting these results from data frame 

plot_lnRR_overall_mods <- ggplot(Overall_effects_not_split, aes(x=ID, y=Effect_Size_lnRR, colour=Experiment_Type)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = ID, y = Effect_Size_lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(title ="Difference between treatment and control in means, overall", x = "ID", y = "lnRR") +
  coord_flip()
 
plot_lnRR_overall_mods

```
#### Split by exposure type and with moderators
```{r, include=FALSE}
#Adding moderators
All_Traits_Analysis_0mods_MG_f0 <- rma.mv(yi, vi, mods = ~F0_Parent_Exposed, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=MG_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_MG_f0)


All_Traits_Analysis_0mods_OF_f0 <- rma.mv(yi, vi, mods = ~F0_Parent_Exposed, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=OF_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_OF_f0)

All_Traits_Analysis_0mods_MG_rodent <- rma.mv(yi, vi, mods = ~Rodent_type, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=MG_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_MG_rodent)

All_Traits_Analysis_0mods_OF_rodent <- rma.mv(yi, vi, mods = ~Rodent_type, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=OF_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_OF_rodent)

All_Traits_Analysis_0mods_MG_sex <- rma.mv(yi, vi, mods = ~Sex, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=MG_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_MG_sex)


All_Traits_Analysis_0mods_OF_sex <- rma.mv(yi, vi, mods = ~Sex, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=OF_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_OF_sex)


```



```{r}

#Plotting Overall with moderators and splitting by exposure type

plot_lnRR_overall_mods_exp <- ggplot(Table_results_overall, aes(x=ID, y=Effect_Size_lnRR, colour=Experiment_Type)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = ID, y = Effect_Size_lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(title ="Difference between treatment and control in means, overall mods", x = "ID", y = "lnRR") +
  coord_flip()
 
plot_lnRR_overall_mods_exp

```


