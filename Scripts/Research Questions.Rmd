---
title: "Research Questions"
author: "Hamza"
date: "17 September 2019"
output: html_document
---

```{r load packages, include=FALSE}
library(tidyverse)
library(openxlsx)  
library(knitr)
library(metafor)
library(ggplot2)
```

# Research Questions
```{r}
# Research Questions 

#1. What is the overall effect of exposure of F0 generation to obesogenic diets on F2 and F3 (if applicable) offspring? 
#2.	What is the overall effect of continuous multigenerational exposure to obesogenic diets on generations F2, F3? 
#3.	Are the effects of exposure of F0 generation to obesogenic diets on F2 and F3 offspring different between #paternal and maternal F0 exposure lines? 
#4.	Are the effects of exposure of F0 generation to obesogenic diets on F2 and F3 generations different between female and male offspring?
#5.	Which traits are the most affected in F2 and subsequent generations?

#For each of the questions listed above, we will look at the effects on both trait means and variability, comparing control and treatment groups at each generation.

```


#Converting characters into factors
```{r}
MG_ALL$Trait <- factor(MG_ALL$Trait)
MG_ALL$Exposure_Type <- factor(MG_ALL$Exposure_Type)
MG_ALL$Sex <- factor(MG_ALL$Sex)
MG_ALL$Generation <- factor(MG_ALL$Generation)
MG_ALL$Cohort_ID <- factor(MG_ALL$Cohort_ID)
MG_ALL$Paper_ID <- factor(MG_ALL$Paper_ID)
MG_ALL$Rodent_type <- factor(MG_ALL$Rodent_type)
MG_ALL$F2_Diet_at_measurement <- factor(MG_ALL$F2_Diet_at_measurement)
MG_ALL$Strain <- factor(MG_ALL$Strain)
MG_ALL$F0_Parent_Exposed <- factor(MG_ALL$F0_Parent_Exposed)



```

```{r}
OF_ALL$Trait <- factor(OF_ALL$Trait)
OF_ALL$Exposure_Type <- factor(OF_ALL$Exposure_Type)
OF_ALL$Sex <- factor(OF_ALL$Sex)
OF_ALL$Generation <- factor(OF_ALL$Generation)
OF_ALL$Cohort_ID <- factor(OF_ALL$Cohort_ID)
OF_ALL$Paper_ID <- factor(OF_ALL$Paper_ID)
OF_ALL$Rodent_type <- factor(OF_ALL$Rodent_type)
OF_ALL$F2_Diet_at_measurement <- factor(OF_ALL$F2_Diet_at_measurement)
OF_ALL$Strain <- factor(OF_ALL$Strain)
OF_ALL$F0_Parent_Exposed <- factor(OF_ALL$F0_Parent_Exposed)

```



# **Overall analysis and then splitting by exposure type (log response ratio)**
```{r}
# Modelling all traits with no mods MG (lnRR)
All_Traits_Analysis_0mods_MG <- rma.mv(yi, vi, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=MG_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_MG)

#Heterogeneity I2 (adapt for all models)
W <- diag(1/MG_ALL$vi)
X <- model.matrix(All_Traits_Analysis_0mods_MG)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_MG <- 100 * sum(All_Traits_Analysis_0mods_MG$sigma2) / (sum(All_Traits_Analysis_0mods_MG$sigma2) + (All_Traits_Analysis_0mods_MG$k-All_Traits_Analysis_0mods_MG$p)/sum(diag(P)))
I2_MG

# OF ALL
All_Traits_Analysis_0mods_OF <- rma.mv(yi, vi, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=OF_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_OF)

W <- diag(1/OF_ALL$vi)
X <- model.matrix(All_Traits_Analysis_0mods_OF)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_OF <- 100 * sum(All_Traits_Analysis_0mods_OF$sigma2) / (sum(All_Traits_Analysis_0mods_OF$sigma2) + (All_Traits_Analysis_0mods_OF$k-All_Traits_Analysis_0mods_OF$p)/sum(diag(P)))
I2_OF

#ALL OF and MG

All_Traits_Analysis_0mods <- rma.mv(yi, vi, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=Effect_Size_All_Traits, method = 'REML')

summary(All_Traits_Analysis_0mods)

#Dataframe was created using results from above meta-analysis models

#Plotting overall

plot_lnRR_overall <- ggplot(Overall_effect_size, aes(x=ID, y=Effect_Size_lnRR, colour=Experiment_Type)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = ID, y = Effect_Size_lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(title ="Difference between treatment and control in means, overall", x = "ID", y = "lnRR") +
  coord_flip()
 
plot_lnRR_overall

#Plotting overall when split by multigenerational and one off exposure

plot_lnRR_overall_exposure <- ggplot(Overall_MG_OF, aes(x=ID, y=Effect_Size_lnRR, colour=Experiment_Type)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = ID, y = Effect_Size_lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(title ="Difference between treatment and control in means, overall", x = "ID", y = "lnRR") +
  coord_flip()
 
plot_lnRR_overall_exposure


```

```{r}

#Adding moderators
All_Traits_Analysis_0mods_MG_f0 <- rma.mv(yi, vi, mods = ~F0_Parent_Exposed, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=MG_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_MG_f0)


All_Traits_Analysis_0mods_OF_f0 <- rma.mv(yi, vi, mods = ~F0_Parent_Exposed, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=OF_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_OF_f0)

All_Traits_Analysis_0mods_MG_rodent <- rma.mv(yi, vi, mods = ~Rodent_type, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=MG_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_MG_rodent)

All_Traits_Analysis_0mods_OF_rodent <- rma.mv(yi, vi, mods = ~Rodent_type, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=OF_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_OF_rodent)

All_Traits_Analysis_0mods_MG_sex <- rma.mv(yi, vi, mods = ~Sex, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=MG_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_MG_sex)


All_Traits_Analysis_0mods_OF_sex <- rma.mv(yi, vi, mods = ~Sex, random = list(~1|Trait, ~1|Paper_ID,~1|Cohort_ID), data=OF_ALL, method = 'REML')

summary(All_Traits_Analysis_0mods_OF_sex)


```



```{r}




#Plotting Overall with moderators

plot_lnRR_overall_mods <- ggplot(Table_results_overall, aes(x=ID, y=Effect_Size_lnRR, colour=Experiment_Type)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = ID, y = Effect_Size_lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(title ="Difference between treatment and control in means, overall mods", x = "ID", y = "lnRR") +
  coord_flip()
 
plot_lnRR_overall_mods

```




