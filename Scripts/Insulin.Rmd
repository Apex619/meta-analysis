---
title: "Insulin"
author: "Hamza"
date: "2 October 2019"
output: html_document
---
## Meta-regression Body Weight

```{r load packages, include=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(openxlsx)  
library(knitr)
library(metafor)
library(ggplot2)
library(readxl)
```

```{r}
Insulin_lnRR <- read.csv("../data/Insulin_lnRR.csv") 

#Subsetting

Insulin_MG <- subset(Insulin_lnRR, Insulin_lnRR$Exposure_Type == "Multigenerational")

Insulin_OF <- subset(Insulin_lnRR, Insulin_lnRR$Exposure_Type == "One off")

```

```{r}

#Overall analysis, not split

Insulin_overall_lnRR_0mods <- rma.mv(yi, vi, random = list(~1|Paper_ID,~1|Cohort_ID), data=Insulin_lnRR, method = 'REML')

summary(Insulin_overall_lnRR_0mods)

#Tibble of overall results

Insulin_overall_lnRR <- tibble(
  ID = "Overall", 
  lnRR = 0.2571,
  ci.lb = -0.0238,
  ci.ub = 0.5381
)

plot_insulin_overall <- ggplot(Insulin_overall_lnRR, aes(x=ID, y=lnRR)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = ID, y = lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(title ="insulin differences, overall", x = "ID", y = "lnRR") +
  coord_flip()
plot_insulin_overall
```

```{r}

#MG then OF

Insulin_overall_MG <- rma.mv(yi, vi, random = list(~1|Paper_ID,~1|Cohort_ID), data=Insulin_MG, method = 'REML')

summary(Insulin_overall_MG)

Insulin_overall_OF <- rma.mv(yi, vi, random = list(~1|Paper_ID,~1|Cohort_ID), data=Insulin_OF, method = 'REML')

summary(Insulin_overall_OF)


#Tibble of results

Insulin_Exp_lnRR <- tibble(
  Exposure_Type = c("Multigenerational", "One off"),
  lnRR = c(0.4624,0.0118),
  ci.lb = c(-0.1455, -0.1559),
  ci.ub = c(1.0703, 0.1795)
)

Insulin_Exp_lnRR



#Plotting when split by exp type

plot_insulin_exp_type <- ggplot(Insulin_Exp_lnRR, aes(x=Exposure_Type, y=lnRR, colour = Exposure_Type)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = Exposure_Type, y = lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(title ="Insulin differences, exp type", x = "Exp_Type", y = "lnRR") +
  coord_flip()
plot_insulin_exp_type
```

#### Running meta-analysis (Overall with moderators, and then overall split by exposure type with moderators)

```{r, echo=FALSE}
#Adding moderators
Insulin_F0 <- rma.mv(yi, vi, mods = ~F0_Parent_Exposed, random = list(~1|Paper_ID,~1|Cohort_ID), data=Insulin_lnRR, method = 'REML')

summary(Insulin_F0)

Glucose_Sex <- rma.mv(yi, vi, mods = ~Sex, random = list(~1|Paper_ID,~1|Cohort_ID), data=Glucose_lnRR, method = 'REML')

summary(Glucose_Sex)

Glucose_Test_Type <- rma.mv(yi, vi, mods = ~Trait_Info, random = list(~1|Paper_ID,~1|Cohort_ID), data=Glucose_lnRR, method = 'REML')

Glucose_Test_Type

#Tibble of results

Glucose_Mods_lnRR <- tibble(
  ID = c("F0 Female", "F0 Male", "Both Sexes Grand Offspring", "Female Grand Offspring", "Male Grand Offspring", "FBG", "GTT"),
  lnRR = c(0.1018,0.0143,0.1546,-0.0632,-0.0543,0.0015,0.1627),
  ci.lb = c(-0.0000,-0.2457,-0.1047,-0.3426,-0.3335,-0.1494,0.0028),
  ci.ub = c(0.2037,0.2742,0.4139,0.2163,0.2249,0.1523,0.3225)
)

plot_glucose_mods <- ggplot(Glucose_Mods_lnRR, aes(x=ID, y=lnRR)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = ID, y = lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(title ="Glucose differences, mods", x = "ID", y = "lnRR") +
  coord_flip()
plot_glucose_mods

```