---
title: "Body Weight"
author: "Hamza"
date: "1 October 2019"
output:
  pdf_document: default
  html_document: default
---
```{r load packages, include=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(openxlsx)  
library(knitr)
library(metafor)
library(ggplot2)
library(readxl)
```


## Meta-analysis Body Weight

```{r}
load(file="Effect_Size_All_Traits.RData")
load(file="Effect_Size_All_Traits_lnCVR.RData")

Body_Weight_lnRR <- subset(Effect_Size_All_Traits, Effect_Size_All_Traits$Trait == "Body_Weight")
```
```{r}

#Subetting (removing BOTH)

Body_Weight_lnRR_MG <- subset(Body_Weight_lnRR, Body_Weight_lnRR$Exposure_Type == "Multigenerational")

Body_Weight_lnRR_OF <- subset(Body_Weight_lnRR, Body_Weight_lnRR$Exposure_Type == "One off")
```

#Overall analysis, not split
```{r}


Body_Weight_overall <- rma.mv(yi, vi, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Body_Weight_lnRR, method = 'REML')

summary(Body_Weight_overall)
funnel(Body_Weight_overall,yaxis="seinv")




#Tibble of overall results

Body_Weight_overall_lnRR <- tibble(
  ID = "Overall", 
  lnRR = Body_Weight_overall$b[1],
  ci.lb = Body_Weight_overall$ci.lb[1],
  ci.ub = Body_Weight_overall$ci.ub[1]
)

plot_BW_overall <- ggplot(Body_Weight_overall_lnRR, aes(x=ID, y=lnRR)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = ID, y = lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(title ="Body Weight differences, overall", x = "ID", y = "lnRR") +
  coord_flip()
plot_BW_overall
```

#Overall analysis when split by exposure type
```{r}



Body_Weight_MG <- rma.mv(yi, vi, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Body_Weight_lnRR_MG, method = 'REML')

summary(Body_Weight_MG)
funnel(Body_Weight_MG,yaxis="seinv")

Body_Weight_OF <- rma.mv(yi, vi, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Body_Weight_lnRR_OF, method = 'REML')

summary(Body_Weight_OF)
funnel(Body_Weight_OF,yaxis="seinv")


#Tibble of results

Body_Weight_Exp_lnRR <- tibble(
  Exposure_Type = c("Multigenerational", "One off"),
  k = c(94),
  lnRR = c(Body_Weight_MG$b[1],Body_Weight_OF$b[1]),
  ci.lb = c(Body_Weight_MG$ci.lb[1],Body_Weight_OF$ci.lb[1]),
  ci.ub = c(Body_Weight_MG$ci.ub[1],Body_Weight_OF$ci.ub[1])
)


Body_Weight_Exp_lnRR



#Plotting when split by exp type

plot_BW_exp_type <- ggplot(Body_Weight_Exp_lnRR, aes(x=Exposure_Type, y=lnRR, colour = Exposure_Type)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0.05, position = position_dodge(0.3)) +
  geom_point(aes(x = Exposure_Type, y = lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Exp_Type", y = "lnRR") +
  coord_flip()
plot_BW_exp_type
```
#### Running meta-analysis (Overall with moderators, and then overall split by exposure type with moderators)

```{r, echo=FALSE}
#Adding moderators
BW_Exp_Type <- rma.mv(yi, vi, mods = ~Exposure_Type-1, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Body_Weight_lnRR, method = 'REML')

BW_Exp_Type
funnel(BW_Exp_Type,yaxis="seinv")

BW_F0 <- rma.mv(yi, vi, mods = ~F0_Parent_Exposed-1, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Body_Weight_lnRR, method = 'REML')

summary(BW_F0)
funnel(BW_F0,yaxis="seinv")

BW_Sex <- rma.mv(yi, vi, mods = ~Sex-1, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Body_Weight_lnRR, method = 'REML')

summary(BW_Sex)
funnel(BW_Sex,yaxis="seinv")

#Tibble of results

Body_Weight_Mods_lnRR <- tibble(
  ID = c("Multigenerational", "One off", "Both", "Female", "Male", "Both", "Female", "Male"),
  Mod = c("Exposure Type", "Exposure Type", "Exposed F0", "Exposed F0","Exposed F0", "Grand-offspring Sex", "Grand-offspring Sex", "Grand-offspring Sex"),
  lnRR = c(BW_Exp_Type$b[1],BW_Exp_Type$b[2],BW_F0$b[1],BW_F0$b[2],BW_F0$b[3],BW_Sex$b[1],BW_Sex$b[2],BW_Sex$b[3]),
  ci.lb = c(BW_Exp_Type$ci.lb[1],BW_Exp_Type$ci.lb[2],BW_F0$ci.lb[1],BW_F0$ci.lb[2],BW_F0$ci.lb[3],BW_Sex$ci.lb[1],BW_Sex$ci.lb[2],BW_Sex$ci.lb[3]),
  ci.ub = c(BW_Exp_Type$ci.ub[1],BW_Exp_Type$ci.ub[2],BW_F0$ci.ub[1],BW_F0$ci.ub[2],BW_F0$ci.ub[3],BW_Sex$ci.ub[1],BW_Sex$ci.ub[2],BW_Sex$ci.ub[3])
)

Body_Weight_Mods_lnRR

plot_BW_mods <- ggplot(Body_Weight_Mods_lnRR, aes(x=ID, y=lnRR)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = ID, y = lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Exp_Type", y = "lnRR") +
  coord_flip()+
  facet_grid(~Mod)
plot_BW_mods

```



```{r}
#splitting by exposure type

Body_Weight_MG_F0 <- rma.mv(yi, vi, mods = ~F0_Parent_Exposed-1, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Body_Weight_lnRR_MG, method = 'REML')

Body_Weight_MG_F0

Body_Weight_OF_F0 <- rma.mv(yi, vi, mods = ~F0_Parent_Exposed-1, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Body_Weight_lnRR_OF, method = 'REML')

Body_Weight_OF_F0
k_exp <- Body_Weight_lnRR_OF %>% group_by(F0_Parent_Exposed) %>% count()
k_exp

Body_Weight_MG_Sex <- rma.mv(yi, vi, mods = ~Sex-1, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Body_Weight_lnRR_MG, method = 'REML')



Body_Weight_MG_Sex

Body_Weight_OF_Sex <- rma.mv(yi, vi, mods = ~Sex-1, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Body_Weight_lnRR_OF, method = 'REML')

Body_Weight_OF_Sex


k_exp <- Body_Weight_lnRR_OF %>% group_by(Sex) %>% count()
k_exp

Overall_Exp_mods_lnRR <- tibble(
  Exposure_Type = c("Multigenerational","Multigenerational", "One off", "One off", "One off", "Multigenerational", "Multigenerational","Multigenerational", "One off","One off","One off" ),
  Sex = c("Female","Male", "Both", "Female", "Male","Both","Female", "Male", "Both","Female", "Male"),
  Mod = c("Exposed F0","Exposed F0","Exposed F0","Exposed F0","Exposed F0","Grand-Offspring","Grand-Offspring","Grand-Offspring","Grand-Offspring","Grand-Offspring","Grand-Offspring"),
  lnRR = c(Body_Weight_MG_F0$b[1],Body_Weight_MG_F0$b[2],Body_Weight_OF_F0$b[1],Body_Weight_OF_F0$b[2],Body_Weight_OF_F0$b[3],Body_Weight_MG_Sex$b[1],Body_Weight_MG_Sex$b[2],Body_Weight_MG_Sex$b[3],Body_Weight_OF_Sex$b[1],Body_Weight_OF_Sex$b[2],Body_Weight_OF_Sex$b[3]),
  ci.lb = c(Body_Weight_MG_F0$ci.lb[1],Body_Weight_MG_F0$ci.lb[2],Body_Weight_OF_F0$ci.lb[1],Body_Weight_OF_F0$ci.lb[2],Body_Weight_OF_F0$ci.lb[3],Body_Weight_MG_Sex$ci.lb[1],Body_Weight_MG_Sex$ci.lb[2],Body_Weight_MG_Sex$ci.lb[3],Body_Weight_OF_Sex$ci.lb[1],Body_Weight_OF_Sex$ci.lb[2],Body_Weight_OF_Sex$ci.lb[3]),
  ci.ub = c(Body_Weight_MG_F0$ci.ub[1],Body_Weight_MG_F0$ci.ub[2],Body_Weight_OF_F0$ci.ub[1],Body_Weight_OF_F0$ci.ub[2],Body_Weight_OF_F0$ci.ub[3],Body_Weight_MG_Sex$ci.ub[1],Body_Weight_MG_Sex$ci.ub[2],Body_Weight_MG_Sex$ci.ub[3],Body_Weight_OF_Sex$ci.ub[1],Body_Weight_OF_Sex$ci.ub[2],Body_Weight_OF_Sex$ci.ub[3])
)

plot_lnRR_overall_mods_exp <- ggplot(Overall_Exp_mods_lnRR, aes(x=Sex, y=lnRR, colour=Exposure_Type))+ 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0.05, position = position_dodge(0.3)) +
  geom_point(aes(x = Sex, y = lnRR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Sex", y = "lnRR") +
  coord_flip()+
  facet_grid(~Mod)
 
plot_lnRR_overall_mods_exp

```

## Meta-analysis overall results (lnCVR)

### 4. Calculating effect sizes (Done)

We calculated our effect sizes (lnCVR) for our complete data set (all traits).
```{r, include = FALSE}

#Subetting

Body_Weight_lnCVR <- subset(Effect_Size_All_Traits_lnCVR, Effect_Size_All_Traits_lnCVR$Trait == "Body_Weight")

Body_Weight_lnCVR_MG <- subset(Body_Weight_lnCVR, Body_Weight_lnCVR$Exposure_Type == "Multigenerational")

Body_Weight_lnCVR_OF <- subset(Body_Weight_lnCVR, Body_Weight_lnCVR$Exposure_Type == "One off")

```

#### 5. Running meta-analysis for body weight lnCVR 

#All Data (lnCVR)
```{r, include = FALSE}


Body_Weight_lnCVR_0mods <- rma.mv(yi, vi, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Body_Weight_lnCVR, method = 'REML')

summary(Body_Weight_lnCVR_0mods)
funnel(Body_Weight_lnCVR_0mods,yaxis="seinv")

#Tibble of overall results

Body_Weight_overall_lnCVR <- tibble(
  ID = "Overall", 
  lnCVR = Body_Weight_lnCVR_0mods$b[1],
  ci.lb = Body_Weight_lnCVR_0mods$ci.lb[1],
  ci.ub = Body_Weight_lnCVR_0mods$ci.ub[1]
)

plot_BW_overall_lnCVR <- ggplot(Body_Weight_overall_lnCVR, aes(x=ID, y=lnCVR)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0.05, position = position_dodge(0.3)) +
  geom_point(aes(x = ID, y = lnCVR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "ID", y = "lnCVR") +
  coord_flip()
plot_BW_overall_lnCVR

```


```{r}

# Modelling all traits with no mods MG (lnCVR)
Body_Weight_lnCVR_0mods_MG <- rma.mv(yi, vi, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Body_Weight_lnCVR_MG, method = 'REML')


summary(Body_Weight_lnCVR_0mods_MG)
funnel(Body_Weight_lnCVR_0mods_MG,yaxis="seinv")



# Modelling all traits with no mods OF (lnCVR)
Body_Weight_lnCVR_0mods_OF <- rma.mv(yi, vi, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Body_Weight_lnCVR_OF, method = 'REML')

summary(Body_Weight_lnCVR_0mods_OF)
funnel(Body_Weight_lnCVR_0mods_OF,yaxis="seinv")


#Tibble of results

Body_Weight_Exp_lnCVR <- tibble(
  Exposure_Type = c("Multigenerational", "One off"),
  lnCVR = c(Body_Weight_lnCVR_0mods_MG$b[1],Body_Weight_lnCVR_0mods_OF$b[1]),
  ci.lb = c(Body_Weight_lnCVR_0mods_MG$ci.lb[1],Body_Weight_lnCVR_0mods_OF$ci.lb[1]),
  ci.ub = c(Body_Weight_lnCVR_0mods_MG$ci.ub[1],Body_Weight_lnCVR_0mods_OF$ci.ub[1])
)

Body_Weight_Exp_lnCVR



#Plotting when split by exp type

plot_BW_exp_type_lnCVR <- ggplot(Body_Weight_Exp_lnCVR, aes(x=Exposure_Type, y=lnCVR, colour = Exposure_Type)) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0.05, position = position_dodge(0.3)) +
  geom_point(aes(x = Exposure_Type, y = lnCVR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Exp_Type", y = "lnCVR") +
  coord_flip()
plot_BW_exp_type_lnCVR


```
#### Running meta-analysis (Overall with moderators)

```{r, echo=FALSE}
#Adding moderators

BW_F0_lnCVR <- rma.mv(yi, vi, mods = ~F0_Parent_Exposed-1, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Body_Weight_lnCVR, method = 'REML')

summary(BW_F0_lnCVR)

BW_Sex_lnCVR <- rma.mv(yi, vi, mods = ~Sex-1, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Body_Weight_lnCVR, method = 'REML')

summary(BW_Sex_lnCVR)

#Tibble of results

Body_Weight_Mods_lnCVR <- tibble(
  ID = c("Both", "Female", "Male", "Both", "Female", "Male"),
  Mod = c("F0 Exposed","F0 Exposed","F0 Exposed","Grand-offspring","Grand-offspring","Grand-offspring"),
  lnCVR = c(BW_F0_lnCVR$b[1], BW_F0_lnCVR$b[2],BW_F0_lnCVR$b[3],BW_Sex_lnCVR$b[1],BW_Sex_lnCVR$b[2],BW_Sex_lnCVR$b[3]),
  ci.lb = c(BW_F0_lnCVR$ci.lb[1], BW_F0_lnCVR$ci.lb[2],BW_F0_lnCVR$ci.lb[3],BW_Sex_lnCVR$ci.lb[1],BW_Sex_lnCVR$ci.lb[2],BW_Sex_lnCVR$ci.lb[3]),
  ci.ub = c(BW_F0_lnCVR$ci.ub[1], BW_F0_lnCVR$ci.ub[2],BW_F0_lnCVR$ci.ub[3],BW_Sex_lnCVR$ci.ub[1],BW_Sex_lnCVR$ci.ub[2],BW_Sex_lnCVR$ci.ub[3])
)

Body_Weight_Mods_lnCVR

plot_BW_mods_lnCVR <- ggplot(Body_Weight_Mods_lnCVR, aes(x=ID, y=lnCVR )) + 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0.05, position = position_dodge(0.3)) +
  geom_point(aes(x = ID, y = lnCVR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "ID", y = "lnCVR") +
  coord_flip()+
  facet_grid(~Mod)
plot_BW_mods_lnCVR
```
# Meta-regression when split by exposure type
```{r}
Body_Weight_MG_F0_lnCVR <- rma.mv(yi, vi, mods = ~F0_Parent_Exposed-1, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Body_Weight_lnCVR_MG, method = 'REML')

Body_Weight_MG_F0_lnCVR
funnel(Body_Weight_MG_F0_lnCVR,yaxis="seinv")

Body_Weight_OF_F0_lnCVR <- rma.mv(yi, vi, mods = ~F0_Parent_Exposed-1, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Body_Weight_lnCVR_OF, method = 'REML')

Body_Weight_OF_F0_lnCVR
funnel(Body_Weight_OF_F0_lnCVR,yaxis="seinv")


Body_Weight_MG_Sex_lnCVR <- rma.mv(yi, vi, mods = ~Sex-1, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Body_Weight_lnCVR_MG, method = 'REML')

Body_Weight_MG_Sex_lnCVR
funnel(Body_Weight_MG_Sex_lnCVR,yaxis="seinv")

Body_Weight_OF_Sex_lnCVR <- rma.mv(yi, vi, mods = ~Sex-1, random = list(~1|Paper_ID,~1|Cohort_ID,~1|ES_ID), data=Body_Weight_lnCVR_OF, method = 'REML')

Body_Weight_OF_Sex_lnCVR
funnel(Body_Weight_OF_Sex_lnCVR,yaxis="seinv")

Overall_Exp_mods_lnCVR <- tibble(
  Exposure_Type = c("Multigenerational","Multigenerational", "One off", "One off", "One off", "Multigenerational", "Multigenerational","Multigenerational", "One off","One off","One off" ),
  Sex = c("Female","Male", "Both", "Female", "Male","Both","Female", "Male", "Both","Female", "Male"),
  Mod = c("Exposed F0","Exposed F0","Exposed F0","Exposed F0","Exposed F0","Grand-offspring","Grand-offspring","Grand-offspring","Grand-offspring","Grand-offspring","Grand-offspring"),
  lnCVR = c(Body_Weight_MG_F0_lnCVR$b[1],Body_Weight_MG_F0_lnCVR$b[2],Body_Weight_OF_F0_lnCVR$b[1],Body_Weight_OF_F0_lnCVR$b[2],Body_Weight_OF_F0_lnCVR$b[3],Body_Weight_MG_Sex_lnCVR$b[1],Body_Weight_MG_Sex_lnCVR$b[2],Body_Weight_MG_Sex_lnCVR$b[3],Body_Weight_OF_Sex_lnCVR$b[1],Body_Weight_OF_Sex_lnCVR$b[2],Body_Weight_OF_Sex_lnCVR$b[3]),
  ci.lb = c(Body_Weight_MG_F0_lnCVR$ci.lb[1],Body_Weight_MG_F0_lnCVR$ci.lb[2],Body_Weight_OF_F0_lnCVR$ci.lb[1],Body_Weight_OF_F0_lnCVR$ci.lb[2],Body_Weight_OF_F0_lnCVR$ci.lb[3],Body_Weight_MG_Sex_lnCVR$ci.lb[1],Body_Weight_MG_Sex_lnCVR$ci.lb[2],Body_Weight_MG_Sex_lnCVR$ci.lb[3],Body_Weight_OF_Sex_lnCVR$ci.lb[1],Body_Weight_OF_Sex_lnCVR$ci.lb[2],Body_Weight_OF_Sex_lnCVR$ci.lb[3]),
  ci.ub = c(Body_Weight_MG_F0_lnCVR$ci.ub[1],Body_Weight_MG_F0_lnCVR$ci.ub[2],Body_Weight_OF_F0_lnCVR$ci.ub[1],Body_Weight_OF_F0_lnCVR$ci.ub[2],Body_Weight_OF_F0_lnCVR$ci.ub[3],Body_Weight_MG_Sex_lnCVR$ci.ub[1],Body_Weight_MG_Sex_lnCVR$ci.ub[2],Body_Weight_MG_Sex_lnCVR$ci.ub[3],Body_Weight_OF_Sex_lnCVR$ci.ub[1],Body_Weight_OF_Sex_lnCVR$ci.ub[2],Body_Weight_OF_Sex_lnCVR$ci.ub[3])
)

plot_lnCVR_overall_mods_exp <- ggplot(Overall_Exp_mods_lnCVR, aes(x=Sex, y=lnCVR, colour=Exposure_Type))+ 
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0.05, position = position_dodge(0.3)) +
  geom_point(aes(x = Sex, y = lnCVR), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Sex", y = "lnCVR") +
  coord_flip()+
  facet_grid(~Mod)
 
plot_lnCVR_overall_mods_exp
```


